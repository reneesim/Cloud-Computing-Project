apiVersion: v1
kind: ConfigMap
metadata:
  name: app-code
  namespace: webapp-mq
data:
  app.py: |
    import os, json, time
    from flask import Flask, request, jsonify
    import pika
    import redis

    RABBIT_HOST = os.getenv("RABBIT_HOST", "rabbitmq")
    RABBIT_USER = os.getenv("RABBIT_USER", "appuser")
    RABBIT_PASS = os.getenv("RABBIT_PASS", "appsecret")
    REDIS_HOST  = os.getenv("REDIS_HOST", "redis")

    app = Flask(__name__)

    def get_rabbit_connection():
      creds = pika.PlainCredentials(RABBIT_USER, RABBIT_PASS)
      params = pika.ConnectionParameters(
        host=RABBIT_HOST,
        credentials=creds,
        heartbeat=30
      )
      return pika.BlockingConnection(params)

    def get_redis():
      return redis.Redis(host=REDIS_HOST, port=6379, decode_responses=True)

    @app.route("/api/submit", methods=["POST"])
    def submit():
      payload = request.get_json(force=True, silent=True) or {}
      value = payload.get("value")
      if value is None:
        return jsonify({"error": "missing 'value'"}), 400

      message = json.dumps({"ts": time.time(), "value": value})
      # Publish to RabbitMQ
      conn = get_rabbit_connection()
      ch = conn.channel()
      ch.queue_declare(queue="jobs", durable=False)
      ch.basic_publish(exchange="", routing_key="jobs", body=message.encode("utf-8"))
      conn.close()

      return jsonify({"status": "queued", "value": value})

    @app.route("/api/stats", methods=["GET"])
    def stats():
      r = get_redis()
      total = int(r.get("total_processed") or 0)
      last = r.get("last_value")
      recent = r.lrange("recent_values", 0, 9)  # latest 10
      return jsonify({"total_processed": total, "last_value": last, "recent": recent})

    @app.route("/", methods=["GET"])
    def root():
      return jsonify({"ok": True, "msg": "NGINX -> App -> MQ -> Worker -> Redis demo"})

    if __name__ == "__main__":
      # Run the Flask app without the reloader (avoids fsnotify/inotify issues)
      print("Starting Flask on 0.0.0.0:5000", flush=True)
      app.run(host="0.0.0.0", port=5000, debug=False, use_reloader=False)


apiVersion: v1
kind: ConfigMap
metadata:
  name: worker-code
  namespace: webapp-mq
data:
  worker.py: |
    import os, json, time, sys
    import pika
    import redis

    RABBIT_HOST = os.getenv("RABBIT_HOST", "rabbitmq")
    RABBIT_USER = os.getenv("RABBIT_USER", "appuser")
    RABBIT_PASS = os.getenv("RABBIT_PASS", "appsecret")
    REDIS_HOST  = os.getenv("REDIS_HOST", "redis")

    r = redis.Redis(host=REDIS_HOST, port=6379, decode_responses=True)

    creds = pika.PlainCredentials(RABBIT_USER, RABBIT_PASS)
    params = pika.ConnectionParameters(host=RABBIT_HOST, credentials=creds, heartbeat=30)
    conn = None

    while True:
      try:
        conn = pika.BlockingConnection(params)
        ch = conn.channel()
        ch.queue_declare(queue="jobs", durable=False)

        def on_msg(ch, method, properties, body):
          try:
            msg = json.loads(body.decode("utf-8"))
            val = msg.get("value")
            if val is not None:
              r.incr("total_processed", amount=1)
              r.lpush("recent_values", val)
              r.ltrim("recent_values", 0, 99)
              r.set("last_value", val)
              print(f"Processed: {val}", flush=True)
          except Exception as e:
            print(f"ERR processing: {e}", file=sys.stderr, flush=True)

        ch.basic_consume(queue="jobs", on_message_callback=on_msg, auto_ack=True)
        print("Worker consuming...")
        ch.start_consuming()
      except Exception as e:
        print(f"Worker connection error: {e}. Retrying in 2s", file=sys.stderr, flush=True)
        time.sleep(2)
